version: 2
jobs:
  test:
    docker:
      -
        image: 'circleci/python:3.6-jessie-browsers'
    steps:
      - checkout
      -
        run: 'sudo apt-get install elasticsearch'
      -
        run: 'curl -X GET "localhost:9200/"'
      -
        run: 'sudo pip install -r requirements.dev.txt'
      -
        run: 'python manage.py collectstatic --no-input'
      -
        run: 'mkdir test-reports'
      -
        run:
          name: 'Download Selenium'
          command: 'curl -O http://selenium-release.storage.googleapis.com/3.5/selenium-server-standalone-3.5.3.jar'
      -
        run:
          name: 'Start Selenium'
          command: 'java -jar selenium-server-standalone-3.5.3.jar -log test-reports/selenium.log'
          background: true
      -
        run: 'mkdir artifacts/'
      -
        save_cache:
          key: 'codalab-{{ .Branch }}-{{ checksum "requirements.dev.txt" }}'
          paths:
            - ~/.cache/pip
      -
        run: py.test
      -
        store_artifacts:
          path: artifacts/
      -
        run: 'flake8 src/ --ignore E501'
workflows:
  version: 2
  build_and_test:
    jobs:
      - test
